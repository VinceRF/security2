<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script>
        $(document).ready(function () {
            if ($.cookie('token')) {
                $.ajaxSetup({
                    headers: {
                        'Authorization': $.cookie('token')
                    }
                })
            } else {
                window.location.href = '/user/loginView';
            }
        })

        function showEdits(boardId) {
            $(`#${boardId}-editarea`).show();
            $(`#${boardId}-submit`).show();
            $(`#${boardId}-delete`).show();
            $(`#${boardId}-goback`).show();

            $(`#${boardId}-content`).hide();
            $(`#${boardId}-edit`).hide();
        }

        function hideEdits(boardId) {
            $(`#${boardId}-editarea`).hide();
            $(`#${boardId}-submit`).hide();
            $(`#${boardId}-delete`).hide();
            $(`#${boardId}-goback`).hide();

            $(`#${boardId}-content`).show();
            $(`#${boardId}-edit`).show();
        }

        function showEditComment(commentId) {
            $(`#${commentId}-editarea2`).show();
            $(`#${commentId}-submit2`).show();
            $(`#${commentId}-delete2`).show();
            $(`#${commentId}-goback2`).show();

            $(`#${commentId}-content2`).hide();
            $(`#${commentId}-edit2`).hide();
        }

        function hideEditComment(commentId) {
            $(`#${commentId}-editarea2`).hide();
            $(`#${commentId}-submit2`).hide();
            $(`#${commentId}-delete2`).hide();
            $(`#${commentId}-goback2`).hide();

            $(`#${commentId}-content2`).show();
            $(`#${commentId}-edit2`).show();
        }

        $(document).ready(function () {
            getMessages();
            getComments();
        })

        // 게시글을 불러옵니다.
        function getMessages() {
            $('#cards-box').empty();
            let idx = location.href.split("boardId=")[1]; //localhost/detail.html?id=12
            $.ajax({
                type: "GET",
                url: `/boards/detail/${idx}`,
                data: {},
                headers: { 'Authorization': $.cookie('token') },
                success: function (response) {
                    console.log(response)
                    let board = response;
                    let boardId = board.boardId;
                    let writer = board.writer;
                    let title = board.title;
                    let content = board.content;
                    let modifiedAt = board.modifiedAt;
                    addHTML(boardId, writer, title, content, modifiedAt);
                }
            });
        }

        // 불러온 게시글을 html에 붙여줍니다.
        function addHTML(boardId, writer, title, content, modifiedAt) {
            let tempHtml = makeMessage(boardId, writer, title, content, modifiedAt);
            $('#cards-box').append(tempHtml);
        }

        // 게시글 형태를 만들어줍니다.
        function makeMessage(boardId, writer, title, content, modifiedAt) {
            return `<div class="card">
                        <div class="metadata">
                           <div id="${boardId}-writer">
                               ${writer}
                           </div>
                           <div class="date">
                               ${modifiedAt}
                           </div>
                        </div>
                    <h2 class='title' id="${boardId}-title">${title}</h2>
                        <div class="contents" id="${boardId}-contents" >
                           ${content}
                        </div>
                            <!--         수정              -->
                            <div id="${boardId}-editarea" class="edit" style="display: none;">
                            <textarea id="${boardId}-textarea" class="te-edit" cols="30" rows="5" style="width: 700px;"></textarea>
                            </div>
                        <div class="myicon">
                                    <i class="fa-solid fa-pen-to-square" style="margin-right: 10px" id="${boardId}-edit" onclick="showEdits('${boardId}')"></i>
                                    <i class="fa-solid fa-file-export" style="margin-right: 10px; display: none;" id="${boardId}-submit" onclick="submitEditBoard('${boardId}')"></i>
                                    <i class="fa-solid fa-trash" style="margin-right: 10px; display: none;" id="${boardId}-delete" onclick="deleteboard('${boardId}')"></i>
                                    <i class="fa-solid fa-rotate-left" style="margin-right: 10px; display: none;" id="${boardId}-goback" onclick="hideEdits('${boardId}')"></i>
                                    </div>
                    </div>`;
        }

        function writeComment() {
            // 1. 작성한 메모를 불러옵니다.
            let content = $('#commentcontent').val();
            let idx = location.href.split("boardId=")[1];
            // 4. 전달할 data JSON으로 만듭니다.
            let data = {'content': content};
            $.ajax({
                type: "POST",
                url: `/comments/write/${idx}`,
                headers: { 'Authorization': $.cookie('token') },
                contentType: "application/json", // JSON 형식으로 전달함을 알리기
                data: JSON.stringify(data),
                success: function (response) {
                    alert('메시지가 성공적으로 작성되었습니다.');
                    window.location.reload();
                }
            });
        }

        function getComments() {
            $('#cards-box').empty();
            let idx = location.href.split("boardId=")[1]; //localhost/detail.html?id=12
            $.ajax({
                type: "GET",
                url: `/comments/list/${idx}`,
                headers: { 'Authorization': $.cookie('token') },
                data: {},
                success: function (response) {
                    console.log(response)
                    for(let i = 0; i< response.length; i++) {
                        let comment = response[i];
                        let commentId = comment.commentId;
                        let commentwriter = comment.commentwriter;
                        let content = comment.content;
                        addHTML2(commentId, commentwriter, content);
                    }
                }
            });
        }
        function addHTML2(commentId, commentwriter, content) {
            let tempHtml2 = makeMessage2(commentId, commentwriter, content);
            $('#comment-box').append(tempHtml2);
        }

        function makeMessage2(commentId, commentwriter, content) {
            return `<div class="card">
                        <div class="metadata">
                           <div id="${commentId}-writer">
                               ${commentwriter}
                           </div>
                        </div>
                        <div id="${commentId}-content2" >
                           ${content}
                        </div>
                        <!--         수정              -->
                            <div id="${commentId}-editarea2" class="edit" style="display: none;">
                            <textarea id="${commentId}-textarea2" class="te-edit" cols="30" rows="5" style="width: 700px;"></textarea>
                            </div>

                        <div class="myicon">
                                    <i class="fa-solid fa-pen-to-square" style="margin-right: 10px" id="${commentId}-edit2" onclick="showEditComment('${commentId}')"></i>
                                    <i class="fa-solid fa-file-export" style="margin-right: 10px; display: none;" id="${commentId}-submit2" onclick="submitEditComment('${commentId}')"></i>
                                    <i class="fa-solid fa-trash" style="margin-right: 10px; display: none;" id="${commentId}-delete2" onclick="deletecomment('${commentId}')"></i>
                                    <i class="fa-solid fa-rotate-left" style="margin-right: 10px; display: none;" id="${commentId}-goback2" onclick="hideEditComment('${commentId}')"></i>
                                    </div>
                    </div>`;
        }

        function deletecomment(commentId) {
            $.ajax({
                type: "DELETE",
                url: `/comments/${commentId}`,
                headers: { 'Authorization': $.cookie('token') },
                success: function (response) {
                    alert('메시지 삭제에 성공하였습니다.');
                    window.location.reload();
                }
            })
        }

        function deleteboard(boardId) {
            $.ajax({
                type: "DELETE",
                url: `/boards/${boardId}`,
                headers: { 'Authorization': $.cookie('token') },
                success: function (response) {
                    alert('메시지 삭제에 성공하였습니다.');
                    window.location.replace("/")
                }
            })
        }

        function submitEditBoard(boardId) {
            let title = $(`#${boardId}-title`).text().trim();
            let content = $(`#${boardId}-textarea`).val().trim();
            let data = {'content': content, 'title': title};
            $.ajax({
                type: "PUT",
                url: `/boards/${boardId}`,
                headers: { 'Authorization': $.cookie('token') },
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert('메시지 변경에 성공하였습니다.');
                    window.location.reload();
                }
            });
        }

        function submitEditComment(commentId) {
            let content = $(`#${commentId}-textarea2`).val().trim();
            let data = {'content': content};
            $.ajax({
                type: "PUT",
                url: `/comments/${commentId}`,
                headers: { 'Authorization': $.cookie('token') },
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    console.log(content)
                    alert('메시지 변경에 성공하였습니다.');
                    window.location.reload();
                }
            });
        }

    </script>
</head>
<body>
<div id="cards-box">
</div>
<div>
    <div class="mb-3">
        <label class="form-label">내용</label>
        <textarea class="form-control" id="commentcontent" rows="3"></textarea>
    </div>
    <div class="mybtn">
        <button onclick="writeComment()">완료</button>
    </div>
</div>
<div id="comment-box">

</div>
</body>
</html>